{% extends 'base.html' %}
{% block content %}

<div class="record-container">
  <h1 class="page-title">ã‚¹ã‚­ãƒ³ã‚±ã‚¢è¨˜éŒ²ãƒ•ã‚©ãƒ¼ãƒ </h1>
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- è¨˜éŒ²æ—¥ -->
    <div class="form-block">
      {{ form.record_date.label_tag }}
      {{ form.record_date }}
    </div>

  <!-- è‚Œã®å†™çœŸ -->
  <div class="form-block">
    {{ form.photo.label_tag }}

    {% if form.photo.value %}
      <div style="margin-top: 4px;">
        {{ form.photo.clear_checkbox }} {{ form.photo.clear_checkbox.label }}
      </div>
    {% endif %}

    {{ form.photo.as_widget }}

    <br>
    <button type="button" id="preview-button" class="btn-sub">ç¾åœ¨ã®è‚Œã®å†™çœŸã‚’ç™»éŒ²</button>
    <br>
    <img id="preview-image" src="#" style="max-width:200px; display:none; margin-top:10px;">
  </div>





    <!-- è‚Œã®èª¿å­ -->
    <div class="form-block">
      <strong>{{ form.skin_rating.label }}</strong>
      <div class="skin-rating-widget">
        {% for radio in form.skin_rating %}
          {% if radio.choice_label != '---------' %}
            <label for="{{ radio.id_for_label }}" style="margin-right:10px;">
              {{ radio.tag }}
              {% if radio.choice_label == "ã¨ã¦ã‚‚è‰¯ã„" %} ğŸ˜„
              {% elif radio.choice_label == "è‰¯ã„" %} ğŸ™‚ 
              {% elif radio.choice_label == "æ™®é€š" %} ğŸ˜ 
              {% elif radio.choice_label == "ã‚„ã‚„æ‚ªã„" %} ğŸ˜• 
              {% elif radio.choice_label == "æ‚ªã„" %} ğŸ˜£ 
              {% endif %}
              {{ radio.choice_label }}
            </label>
          {% endif %}
        {% endfor %}
      </div>
    </div>

    <!-- è‚Œã®çŠ¶æ…‹ãƒ¡ãƒ¢ -->
    <p class="form-block">{{ form.skin_condition.label_tag }}<br>{{ form.skin_condition }}</p>

    <!-- æœ -->
    <div class="form-block">
      <label class="section-title">ğŸŒ æœã«ä½¿ã£ãŸã‚¢ã‚¤ãƒ†ãƒ </label>
      <div id="morning-inputs"></div>
      <button type="button" id="add-morning-item" class="btn-sub">ï¼‹é …ç›®ã‚’è¿½åŠ ã™ã‚‹</button>
    </div>

    <!-- å¤œ -->
    <div class="form-block">
      <label class="section-title">ğŸŒ™ å¤œã«ä½¿ã£ãŸã‚¢ã‚¤ãƒ†ãƒ </label>
      <div id="night-inputs"></div>
      <button type="button" id="add-night-item" class="btn-sub">ï¼‹é …ç›®ã‚’è¿½åŠ ã™ã‚‹</button>
    </div>


    <!-- hidden -->
    <input type="hidden" name="morning_items" id="id_morning_items" value="{{ form.initial.morning_items|default:''|escape }}">
    <input type="hidden" name="night_items" id="id_night_items" value="{{ form.initial.night_items|default:''|escape }}">
    <input type="hidden" name="ingredients" id="id_ingredients" value="{{ form.initial.ingredients|default:''|escape }}">

    <div class="form-actions">
      <button type="submit">è¨˜éŒ²ã™ã‚‹</button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  function addItem(sectionId, prefix, category='', name='', ingredient='') {
    const container = document.getElementById(sectionId);
    const count = container.querySelectorAll('.item-row').length;
    if (count >= 10) {
      alert("æœ€å¤§10ä»¶ã¾ã§è¿½åŠ ã§ãã¾ã™ã€‚");
      return;
    }
    const row = document.createElement("div");
    row.className = "item-row";
    row.innerHTML = `
      <div class="row-header">
        <button type="button" class="remove-btn btn-danger">ï¼</button>
        <label class="item-label">${count + 1}ç•ªç›®ï¼š</label>
      </div>
      <input type="text" class="${prefix}-input-category" value="${category}" placeholder="ã‚«ãƒ†ã‚´ãƒªï¼ˆä¾‹ï¼šåŒ–ç²§æ°´ï¼‰">
      <input type="text" class="${prefix}-input-name" value="${name}" placeholder="å•†å“å">
      <input type="text" class="${prefix}-input-ingredient" value="${ingredient}" placeholder="æˆåˆ†ï¼ˆä»»æ„ï¼‰">
    `;
    container.appendChild(row);
    bindRemove();
    bindInputEvents();
  }

  function bindRemove() {
    document.querySelectorAll('.remove-btn').forEach(btn => {
      btn.onclick = () => {
        const row = btn.closest('.item-row');
        if (row) row.remove();
      };
    });
  }

  function updateHiddenInputs(sectionId, prefix, targetId) {
    const rows = document.querySelectorAll(`#${sectionId} .item-row`);
    const items = Array.from(rows).map(row => {
      const category = row.querySelector(`.${prefix}-input-category`)?.value.trim() || '';
      const name = row.querySelector(`.${prefix}-input-name`)?.value.trim() || '';
      const ingredient = row.querySelector(`.${prefix}-input-ingredient`)?.value.trim() || '';
      return `${category}:${name}:${ingredient}`;
    }).filter(item => item !== '::');
    document.getElementById(targetId).value = items.join(', ');
  }

  function bindInputEvents() {
    document.querySelectorAll('.morning-input-category, .morning-input-name, .morning-input-ingredient').forEach(el => {
      el.addEventListener('input', () => {
        updateHiddenInputs('morning-inputs', 'morning', 'id_morning_items');
      });
    });
    document.querySelectorAll('.night-input-category, .night-input-name, .night-input-ingredient').forEach(el => {
      el.addEventListener('input', () => {
        updateHiddenInputs('night-inputs', 'night', 'id_night_items');
      });
    });
  }

  // âœ… ä¿å­˜æ¸ˆã¿ã®å†…å®¹ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
  function loadExistingItems(csvStr, sectionId, prefix) {
    const items = csvStr.split(',').map(s => s.trim()).filter(Boolean);
    const container = document.getElementById(sectionId);
    container.innerHTML = "";

    items.forEach((item, index) => {
      const parts = item.split(':');
      const category = (parts[0] && parts[0] !== 'None') ? parts[0] : '';
      const name = parts[1] || '';
      const ingredient = parts[2] || '';
      addItem(sectionId, prefix, category, name, ingredient);
    });

    if (items.length === 0) {
      for (let i = 0; i < 3; i++) addItem(sectionId, prefix);
    }
  }

  // âœ… å‘¼ã³å‡ºã—ï¼ˆåˆæœŸå€¤ã‹ã‚‰å¾©å…ƒï¼‰
  const morningRaw = "{{ form.morning_items.value|escapejs }}";
  const nightRaw = "{{ form.night_items.value|escapejs }}";
  loadExistingItems(morningRaw, "morning-inputs", "morning");
  loadExistingItems(nightRaw, "night-inputs", "night");

  document.getElementById("add-morning-item").addEventListener("click", () => addItem("morning-inputs", "morning"));
  document.getElementById("add-night-item").addEventListener("click", () => addItem("night-inputs", "night"));

  document.querySelector('form').addEventListener('submit', function () {
    updateHiddenInputs('morning-inputs', 'morning', 'id_morning_items');
    updateHiddenInputs('night-inputs', 'night', 'id_night_items');
    const ingredients = Array.from(document.querySelectorAll('.morning-input-ingredient, .night-input-ingredient'))
      .map(i => i.value.trim()).filter(Boolean).join(', ');
    document.getElementById('id_ingredients').value = ingredients;
  });

  // âœ… å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
  const photoInput = document.getElementById("id_photo");
  const previewBtn = document.getElementById("preview-button");
  const previewImage = document.getElementById("preview-image");
  if (previewBtn && photoInput && previewImage) {
    previewBtn.addEventListener("click", function () {
      const file = photoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
      }
    });
  }

});
</script>

{% endblock %}
