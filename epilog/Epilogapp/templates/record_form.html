{% extends 'base.html' %}
{% block content %}

<style>
  .record-container {
    max-width: 1000px;
    margin: 40px auto;
    padding: 30px 20px;
    background-color: #ffffff;
    border-radius: 12px;
  }

  .page-title {
    text-align: center;
    font-size: 24px;
    margin-bottom: 30px;
  }

  .form-group,
  .photo-section,
  .concern-block,
  .form-actions {
    margin-bottom: 30px;
  }

  .care-sections {
    display: flex;
    gap: 40px;
    justify-content: space-between;
    margin-top: 30px;
  }

  .care-block {
    flex: 1;
    background-color: #f5f9f6;
    padding: 20px;
    border: 1px solid #a7d7c5;
    border-radius: 12px;
  }

  .care-block h3 {
    text-align: center;
    margin-bottom: 20px;
    font-size: 18px;
  }

  .item-row {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
    margin-bottom: 12px;
  }
  
  .row-header {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .item-label {
    font-weight: bold;
    white-space: nowrap;
    margin: 0;
    padding: 0;
    line-height: 1;
    display: flex;
    align-items: center; 
    margin-top: 15px;
  }
  
  
  .item-row input {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 4px;
  }

  .item-row select {
    width: 100%;
    padding: 6px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 6px;
    margin-bottom: 4px;
  }
  

  label {
    font-weight: bold;
    display: block;
    margin-bottom: 5px;
  }

  .condition-icons {
    display: flex;
    justify-content: center;
    gap: 30px;
    margin-top: 10px;
  }

  .face-label span {
    display: block;
    text-align: center;
    font-size: 14px;
  }

  .form-actions {
    text-align: center;
  }

  button {
    background-color: #a7d7c5;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    margin-top: 20px;
  }

  .remove-btn {
    background-color: #eee;
    color: #333;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    width: 26px;
    height: 26px;
    padding: 0;
    line-height: 1;
    margin-right: 8px;
    cursor: pointer;
    vertical-align: middle;
  }
  

  a {
    text-align: center;
    display: block;
    margin-top: 20px;
  }

  .condition-icons {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin-top: 10px;
  }

  .skin-rating-option {
    width: 70px;
    text-align: center;
    padding: 8px;
    cursor: pointer;
  }

  .skin-rating-option .icon {
    font-size: 32px;
    line-height: 1;
    display: block;
    text-align: center;
  }

  .skin-rating-option.selected {
    border: 2px solid #3ba58b;
    background-color: #e0f4ef;
    border-radius: 8px;
  }

  .skin-rating-option input[type="radio"] {
    display: none;
  }

  .skin-rating-option .label-text {
    margin-top: 5px;
    font-size: 14px;
  }

  .photo-section {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 40px;
    margin-bottom: 30px;
  }
  
  .photo-section .left-block,
  .photo-section .right-block {
    flex: 1;
  }
  
  #preview-button {
    margin-top: 10px;
  }

  #id_skin_condition {
    display: block;
    margin: 0 auto;          
    width: 90%;              
    max-width: 800px;
    height: 80px;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 14px;
    resize: vertical;
  }
  
  #add-morning-item,
  #add-night-item {
    background-color: #a7d7c5;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
  }


</style>


<div class="record-container">
  <h1 class="page-title" style="text-align:center;">スキンケア記録フォーム</h1>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    {% if form.errors %}
    <div style="background-color: #fce4e4; border: 1px solid #f5c2c2; color: #c72c2c;
            padding: 10px; margin: 15px auto; max-width: 600px; border-radius: 6px;">
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li>{{ field.label }}: {{ error }}</li>
          {% endfor %}
        {% endfor %}
      </ul>
    </div>
  {% endif %}

    <!-- 肌の写真アップロード -->
    <div class="photo-section">
      <div class="left-block">
        <label>{{ form.record_date.label }}</label><br>
        {{ form.record_date }}
      </div>
      <div class="right-block">
        <label>{{ form.photo.label }}</label><br>
        {{ form.photo }}<br>
        <button type="button" id="preview-button">現在の肌の写真を登録</button>
        <div id="photo-preview" style="margin-top: 10px;">
          <img id="preview-image" src="#" alt="プレビュー画像"
               style="max-width: 250px; display: none; border-radius: 8px;">
        </div>
      </div>
    </div>
    

    <!-- 肌の調子（顔アイコン付き） -->
    <div class="form-group">
      <strong>{{ form.skin_rating.label }}</strong>
      <div class="condition-icons">
        {% for value, label in form.fields.skin_rating.choices %}
          <label class="face-label skin-rating-option"
                 style="display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 5px; border-radius: 8px;">
            <input type="radio" name="skin_rating" value="{{ value }}"
              {% if form.data.skin_rating == value|stringformat:"s" %}checked{% endif %}>
            <span class="icon" style="font-size: 32px;">
              {% if label == "とても良い" %} 😄
              {% elif label == "良い" %} 🙂 
              {% elif label == "普通" %} 😐 
              {% elif label == "やや悪い" %} 😕 
              {% elif label == "悪い" %} 😣 
              {% endif %}
            </span>
            <span class="label-text">{{ label }}</span>
          </label>
        {% endfor %}
      </div>
    </div>
    



    <!-- 肌悩み -->
    <div class="concern-block">
      <p><strong>{{ form.concerns.label }}</strong></p>
      <div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
        {% for checkbox in form.concerns %}
          <label style="display: flex; align-items: center; gap: 5px;">
            {{ checkbox.tag }} {{ checkbox.choice_label }}
          </label>
        {% endfor %}
      </div>
    </div>
    

    <!-- 肌の状態メモ -->
    <p>
      {{ form.skin_condition.label_tag }}<br>
      {{ form.skin_condition }}
    </p>

    <!-- 朝・夜のスキンケア -->
    <div class="care-sections">

      <!-- 朝 -->
      <div class="care-block" id="morning-block">
        <strong>🌞 朝に使ったアイテム</strong>
        <div id="morning-inputs">
          {% for i in "123456" %}
            <div class="item-row">
              <div class="row-header">
                <button type="button" class="remove-btn">－</button>
                <label class="item-label">{{ forloop.counter }}番目：</label>
              </div>
              <select class="item-type">
                <option value="">種類を選択</option>
                <option value="クレンジング">クレンジング</option>
                <option value="洗顔">洗顔</option>
                <option value="導入美容液">導入美容液</option>
                <option value="化粧水">化粧水</option>
                <option value="乳液">乳液</option>
                <option value="美容液">美容液</option>
                <option value="クリーム">クリーム</option>
                <option value="パック">パック</option>
                <option value="その他">その他</option>
              </select>
              <input type="text" class="morning-input-name" placeholder="商品名">
              <input type="text" class="morning-input-ingredient" placeholder="成分名（任意）">
            </div>
          {% endfor %}
        </div>        
        <button type="button" id="add-morning-item">＋項目を追加する</button>
        {{ form.morning_items.as_hidden }}
      </div>
      

      <!-- 夜 -->
      <div class="care-block" id="morning-block">
        <strong>🌙 夜に使ったアイテム</strong>
        <div id="night-inputs">
          {% for i in "123456" %}
            <div class="item-row">
              <div class="row-header">
                <button type="button" class="remove-btn">－</button>
                <label class="item-label">{{ forloop.counter }}番目：</label>
              </div>
              <select class="item-type">
                <option value="">種類を選択</option>
                <option value="クレンジング">クレンジング</option>
                <option value="洗顔">洗顔</option>
                <option value="導入美容液">導入美容液</option>
                <option value="化粧水">化粧水</option>
                <option value="乳液">乳液</option>
                <option value="美容液">美容液</option>
                <option value="クリーム">クリーム</option>
                <option value="パック">パック</option>
                <option value="その他">その他</option>
              </select>
              <input type="text" class="morning-input-name" placeholder="商品名">
              <input type="text" class="morning-input-ingredient" placeholder="成分名（任意）">
            </div>
          {% endfor %}
        </div>
          
        <button type="button" id="add-night-item">＋項目を追加する</button>
        {{ form.night_items.as_hidden }}
      </div>
    </div>

    
    <!-- 登録ボタン -->
    <div class="form-actions">
      <button type="submit">記録する</button>
    </div>
  </form>
  
</div>

<!-- 入力内容をまとめて保存するJS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ✅ 肌の調子：顔アイコン選択処理（最初に閉じる！）
  const options = document.querySelectorAll('.skin-rating-option');
  options.forEach(option => {
    option.addEventListener('click', function () {
      options.forEach(opt => opt.classList.remove('selected'));
      this.classList.add('selected');

      const radio = this.querySelector('input[type="radio"]');
      if (radio) {
        radio.checked = true;
      }
    });
  });

    // ✅ 肌の写真プレビュー機能
    const previewButton = document.getElementById("preview-button");
    const photoInput = document.getElementById("id_photo");
    const previewImage = document.getElementById("preview-image");
  
    previewButton.addEventListener("click", function () {
      const file = photoInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImage.src = e.target.result;
          previewImage.style.display = "block";
        };
        reader.readAsDataURL(file);
      } else {
        alert("画像ファイルを選択してください。");
      }
    });
  
    // ✅ 朝アイテム追加・削除
    let morningCount = 6;
    const morningInputs = document.getElementById("morning-inputs");
    const addMorningBtn = document.getElementById("add-morning-item");
  
    addMorningBtn.addEventListener("click", function () {
      const currentRows = morningInputs.querySelectorAll('.item-row').length;
    
      if (currentRows >= 10) {
        alert("朝は最大10件まで追加できます。");
        return;
      }
    
      const div = document.createElement("div");
      div.className = "item-row";
      div.innerHTML = `
      <div class="row-header">
        <button type="button" class="remove-btn">－</button>
        <label class="item-label">番目：</label>
      </div>
      <input type="text" class="morning-input-name" placeholder="商品名">
      <input type="text" class="morning-input-ingredient" placeholder="成分名（任意）">
    `;
    
      morningInputs.appendChild(div);
    
      updateListeners();
      renumberItems('#morning-inputs');
    });
    
    
    function renumberItems(parentSelector) {
      const container = document.querySelector(parentSelector);
      if (!container) return;
    
      const rows = container.querySelectorAll('.item-row');
      rows.forEach((row, index) => {
        const label = row.querySelector('label');
        if (label) {
          label.textContent = `${index + 1}番目：`;
        }
      });
    }
    


  
    // ✅ 夜アイテム追加・削除
    let nightCount = 6;
    const nightInputs = document.getElementById("night-inputs");
    const addNightBtn = document.getElementById("add-night-item");
  
    addNightBtn.addEventListener("click", function () {
      const currentRows = nightInputs.querySelectorAll('.item-row').length;
    
      if (currentRows >= 10) {
        alert("夜は最大10件まで追加できます。");
        return;
      }
    
      const div = document.createElement("div");
      div.className = "item-row";
      div.innerHTML = `
      <div class="row-header">
        <button type="button" class="remove-btn">－</button>
        <label class="item-label">番目：</label>
      </div>
      <input type="text" class="night-input-name" placeholder="商品名">
      <input type="text" class="night-input-ingredient" placeholder="成分名（任意）">
    `;
    
      nightInputs.appendChild(div);
    
      updateListeners();
      renumberItems('#night-inputs');
    });
    
    

    function renumberItems(parentSelector) {
      const container = document.querySelector(parentSelector);
      if (!container) return;
    
      const rows = container.querySelectorAll('.item-row');
      rows.forEach((row, index) => {
        const label = row.querySelector('label');
        if (label) {
          label.textContent = `${index + 1}番目：`;
        }
      });
    }
  
    // ✅ 削除ボタン動作
    function updateListeners() {
      document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.onclick = () => {
          const row = btn.closest('.item-row');
          if (row) row.remove();
          renumberItems('#morning-inputs'); // 朝の番号振り直し
          renumberItems('#night-inputs');   // 夜の番号振り直し
        };
      });
    }
    
  
    // ✅ 朝・夜の入力値をhiddenに反映（既存の処理）
    function updateInputs(inputClass, targetId) {
      const values = Array.from(document.querySelectorAll('.' + inputClass))
                          .map(input => input.value.trim())
                          .filter(v => v);
      const hiddenInput = document.getElementById(targetId);
      if (hiddenInput) {
        hiddenInput.value = values.join(', ');
      }
    }
  
    document.addEventListener('input', () => {
      updateInputs('morning-input-name', '{{ form.morning_items.id_for_label }}');
      updateInputs('night-input-name', '{{ form.night_items.id_for_label }}');
    });
  });
  </script>
  
  


<p style="text-align:center;"><a href="{% url 'home' %}">← ホームに戻る</a></p>


{% endblock %}
